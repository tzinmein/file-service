# file-service

A scalable, general purpose file server based on ASP.NET Core.  
Often back-end projects may have upload/download needs such as avatars, images, audio, video, etc., which can be abstracted into a file service.

_Read this in other languages: [English](README.md), [简体中文](README.zh-cn.md)._

## Functional Features

- Support Linux (recommended), Windows
- scalable architecture, support the deployment of 1-N file servers
- RESTful architecture API interface, support for multi-language clients
- support for file transfer in seconds, breakpoints, remote pull uploads
- support for user-specified disk space quota
- support for customizing file processor

## System Architecture

![Scheme](https://raw.githubusercontent.com/md-frank/file-service/master/doc/fs-scheme.jpg)

- File upload/download is usually done by the client directly interacting with the file server, when uploading, you need to provide a token representing the user's identity (generated by the business server), and the root address of the file will be returned upon success.
- Can also be directly uploaded by the business server to return the root address of the file to the client.
- .NET Standard-based server-side SDK is included in the source code, which can generate tokens, upload files and so on.
- .NET Standard-based client SDK is included in the source code, which can upload/download files.

## Backend Usage

Configuring the Business Server

```
//Startup.cs code segment
public void ConfigureServices(IServiceCollection services)
{
    //....
    services.AddFileService(opts =>
    {
        opts.Host = "fs.mondol.info"; //File server domain name
        opts.AppSecret = "xxxxxx"; //Encryption key, which needs to be the same as the file server
    });
}
```

Generating access tokens

```
IFileServiceManager fileSvceMgr; //This example is available through the DI Framework
//Specify the meaning according to the business, e.g. 1 - for administrator, 2 - for user
var ownerType = 2;
var ownerId = 2; // if ownerType=2, then user ID
var validTime = TimeSpan.FromDays(2); //token validity period
var ownerToken = fileSvceMgr.GenerateOwnerTokenString(ownerType, ownerId, validTime);
```

## Front End Usage

File Upload

```
IFileServiceClient fileClient; //This example is available through the DI Framework
var ownerToken = "Token returned by business server";
var periodMinute = 0; //validity period，0 for non-expiring
var updResult = await fileClient.UploadAsync(ownerToken, "file path", periodMinute);
var url = updResult.Data.Url; //Get the root address of the file
```

## Description of URL format

The full URL format looks like this: `https://domain.com/{fileToken}/{handler}/{modifier}`  
`fileToken`: the unique identifier of the file to be uploaded.  
`handler`: file handler, can be image, video, raw, etc.  
`modifier`: [optional] file processor parameter, e.g. image processor, can specify 128x128_png

The `file root address (updResult.Data.Url)` returned after a successful file upload is the URL as of `https://domain.com/{fileToken}` The latter part of the URL is spliced by the client according to needs.

### The following is an example:

Download the original file  
File root address /raw, for example:  
`http://file.domain.com/files/1iYQTU7fEUgaa~URSVwaCqQKFml_IAAAAAgAAAAbhmsFjiUUQwCPn2ngI1QcvsSp0AA/raw`

Download a 128x128 sized thumbnail (the original file is an image)  
File root address /image/128x128, for example:  
`http://file.domain.com/files/1iYQTU7fEUgaa~URSVwaCqQKFml_IAAAAAgAAAAbhmsFjiUUQwCPn2ngI1QcvsSp0AA/image/128x128`

Download 128 wide, high aspect ratio scaled thumbnail (original file is an image)  
File root address /image/128x, for example:  
`http://file.domain.com/files/1iYQTU7fEUgaa~URSVwaCqQKFml_IAAAAAgAAAAbhmsFjiUUQwCPn2ngI1QcvsSp0AA/image/128x`

The original image is in JPG format, download the image in png format  
File root address /image/raw_png, for example:  
`http://file.domain.com/files/1iYQTU7fEUgaa~URSVwaCqQKFml_IAAAAAgAAAAbhmsFjiUUUQwCPn2ngI1QcvsSp0AA/image/raw_png`

The original image is in JPG format, download a 128x128 sized thumbnail image in png format  
File root address /image/128x128_png, for example:  
`http://file.domain.com/files/1iYQTU7fEUgaa~URSVwaCqQKFml_IAAAAAgAAAAbhmsFjiUUQwCPn2ngI1QcvsSp0AA/image/128x128_png`

## Contact Details

Email: tzinmein@gmail.com  
Blog: https://tzin.net

## Original Author

Email: frank@mondol.info\
cnblogs: http://mondol.cnblogs.com
